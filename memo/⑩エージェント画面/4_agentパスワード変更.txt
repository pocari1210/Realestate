
4_agentパスワード変更

◆ルートの編集◆

ディレクトリ
\routes\web.php

・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・

Route::middleware(['auth', 'role:agent'])->group(function () {

  // agent:パスワード変更(編集)のルート
  Route::get('/agent/change/password', [AgentController::class, 'AgentChangePassword'])
    ->name('agent.change.password');

  // agent:パスワード更新のルート
  Route::post('/agent/update/password', [AgentController::class, 'AgentUpdatePassword'])
    ->name('agent.update.password');


/////////////////////////////////////////////////////////////////////////////////////////////////

◆ビューの編集(遷移元)◆

ディレクトリ
\resources\views\agent\body\header.blade.php

・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・

<li class="dropdown-item py-2">
  <a href="{{ route('agent.change.password') }}" class="text-body ms-0">
    <i class="me-2 icon-md" data-feather="edit"></i>
    <span>Change Password</span>
  </a>
</li>

/////////////////////////////////////////////////////////////////////////////////////////////////

◆コントローラーの編集◆

ディレクトリ
\app\Http\Controllers\AgentController.php

・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・

  public function AgentChangePassword()
  {

    $id = Auth::user()->id;
    $profileData = User::find($id);
    return view('agent.agent_change_password', compact('profileData'));
  } // End Method 


  public function AgentUpdatePassword(Request $request)
  {

    // Validation 
    $request->validate([
      'old_password' => 'required',
      'new_password' => 'required|confirmed'
    ]);

    // Hash::checkでフォームに入力された過去のパスワードと、
    // DBに登録したパスワード情報が一致しているか判定をしている
    if (!Hash::check($request->old_password, auth::user()->password)) {

      $notification = array(
        'message' => 'Old Password Does not Match!',
        'alert-type' => 'error'
      );

      return back()->with($notification);
    }

    // ログインしているアカウントのパスワード情報を
    // ハッシュ化し、更新している
    User::whereId(auth()->user()->id)->update([
      'password' => Hash::make($request->new_password)
    ]);

    $notification = array(
      'message' => 'パスワードの変更に成功しました',
      'alert-type' => 'success'
    );

    return back()->with($notification);
  } // End Method 

/////////////////////////////////////////////////////////////////////////////////////////////////

◆ビューの編集(遷移元)◆

ディレクトリ
\resources\views\agent\agent_change_password.blade.php

・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・・

\resources\views\admin\admin_change_password.blade.php
を元に作成する